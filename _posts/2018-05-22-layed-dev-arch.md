---
layout: post
title:  "浅谈微服务体系中的DDD领域设计和分层之道"
date:   2017-09-01 13:29:18 +0800
categories: 架构师
tags: DDD 分层设计 Layered-Architecture
author: Tommy.Tesla
mathjax: true
---

### 摘要

本文阐述了一种将DDD领域设计和其主张的分层设计方法应用于微服务体系架构的方案实践，也是个人的最佳实践。这种方案目前在本人所在的公司运作的不错。总结来说，本文主张将一个互联网公司的Web服务架构分为五层：基础设施层、领域服务层、应用服务层、网关层和用户界面层（表示层）。领域服务层和应用服务层均可以采用微服务设计进行拆分，其中领域服务层将严格按照DDD定义的领域模型和模块进行设计。这种方案的确用起来得心应手，把大系统以一种科学的方式分而治之，但同时也对架构师和开发人员提出了更高的要求。本文先阐述了下背景，然后探讨了为什么我们需要分层设计，其原理和好处又是什么，第三部分结合微服务和DDD进行对领域层的服务模块划分和设计。文章的最后则是一些总结和延展思考。
 
### 背景介绍

想写这样一篇文章很久了，可惜碍于自己能力有限，从08年写代码以来一直断断续续的思考，始终对项目代码结构设计（分包、分层）没有一个可以让自己觉得无瑕疵的答案，假设了某个设计，很快在实践中又会发现其存在着一些问题。直到2014年毕业工作后了解了DDD领域驱动设计后，才有了相对清晰的方向。实际上早在2004年，Eric Envas的《领域驱动设计：软件核心复杂性应对之道》就出版了，毕竟软件开发自计算机普及以来已经存在很长一段时间了，早期国外程序员对软件开发理论的研究也十分兴盛，如今成熟后反而研究的相对少了，基本上依葫芦画瓢即可。**DDD领域驱动设计**对软件设计各个环节的人员都有较高的要求,用《领域驱动设计》一书的话来说它需要一个“领域驱动团队”[1]，它要求从分析阶段，产品经理、项目经理、架构师以及开发工程师就使用统一的模型语言（Ubiquitous Language）来进行沟通，并且他们都懂一些代码、产品和建模相关的知识，事实上这在国内很难实施，国内的产品经理约等于需求整理工，对其计算机基础的要求是少之又少，在我所从事的公司里，也曾发生过产品经理直接指导开发，以至于后面双方理解的同一个词有着不同含义的情况。近年来，随着分布式的发展，传统中小型机集中式服务器已经不在流行，所以微服务体系也成为了各大互联网公司主流的选择。直观的感受下**微服务**和**DDD**两者，似乎一个是把大系统拆成小系统的，另一个则是大系统的设计方法，似乎两者天生互斥，微服务化的小系统也用不着DDD，其实并不是，DDD是针对整个复杂的软件解决方案的一种科学设计方法，微服务化也是把复杂的大系统拆分为小系统，方便维护和管理，所以两者都有一个特点——为复杂的大系统服务。下面咱们就来探讨下，如何把DDD的领域设计和其主张的分层设计应用到微服务体系架构中。需要说明的是本文主要是个人十多年来的一点总结，未必适合所有场景，有更好更易理解的设计方式请不吝赐教。

### 分层设计

准确的说分层设计（Layered Architecture）跟DDD没有必然的联系，本人最早接触分层设计是在携程网，当时内部使用的应该只是简单的业务层（Biz）和表示层，数据库访问之类的也是放在各自的业务包下的，后来翻阅和学习了《领域驱动设计：软件核心复杂性应对之道》，书的第4章“分离领域”中说到了四层分层设计，即：基础设施层、领域层、应用层和用户界面层（表示层）。DDD产生的年代微服务还未流行，当时甚至基于浏览器的Web应用都比较少，更多的是PC软件，所以作者更多的是想表达对复杂系统的逻辑分层，并不在意每个领域是单独的系统或是一个软件系统内不同的模块。所以为了跟其做区分，我们建议的四层为在其基础上引入“服务”两个字，即：基础设施层、领域服务层、应用服务层和用户界面层。这样做的意图是让开发人员立刻可以了解到——每个领域模块即一个微服务。
摘要中提到我们主张的分层体系中还有一个层，即**网关层**，这又是什么鬼呢。刚刚提到的DDD的时代背景，PC软件系统或者企业内部使用的网络应用系统是根本没有网关这一说的，而现如今互联网公司产品的输出形式无外乎Web应用（网站、或者网络服务），这时候会产生一个需求——内部网络应用系统如何把自己的服务输出到互联网上，供外部系统访问。最直接的方式就是把应用层直接暴露在公网上，但这样做有以下缺陷：
* 应用层不具备负载均衡的功能。
* 应用层服务可能数量众多，删减频繁，直接发布到公网带来的运维工作量巨大。
* 应用层服务更多的是关注业务应用，对系统安全性（防DDOS、钓鱼、跨域等）、请求监控等缺乏考虑。

这时候我们在Web应用系统中引入网关层用于衔接**表示层**和**应用层**，可以更好的划分各层的职能。网关层也可以看作是应用服务层的对外包装层。如果一定要把网关层做到应用服务层里理论上也是可行的，但是最佳实践告诉我们，往往应用服务层是一个微服务，而对外提供的接口往往是Restful的，所以索性增加一个网关层，让应用服务层只关心自己的业务实现，其他安全性，负载均衡，网络控制等交给网关层统一管理。这样我们就得到了以下网络应用系统分层体系：
 ![Our Proposed Layered Architecture](/image/layed-arch/layerd-architecture.png)



### 


### 参考文献
1. 领域驱动设计：软件核心复杂性应对之道。**Eric Envas**，前言部分。


* content
{:toc}