---
 layout: post
 title:  传输控制协议（Transmission Control Protocol）原文翻译选段
 date:   2018-03-01 21:29:18 +0800
 categories: 网络编程
 tags: 网络编程
 author: Tommy.Tesla
 mathjax: true
---

[RFC793原文地址](https://www.ietf.org/rfc/rfc793.txt)

## 2.7 链接建立和清除

为了识别互相独立的多个数据流，TCP设计出端口的概念。由于每个TCP客户端的端口是他们自己选出来的，保不齐会存在两个一样的端口。为了得到一个绝对唯一的TCP参与者身份标识，我们（是指TCP设计者）将网络地址（IP）和端口连在一起来创建一个套接字，这样就能保证这个套接字在整个可达网络里是绝对唯一的。

> 译者注：套接字Socket = 网络地址IP : 端口PROT

一个TCP链接由一对套接字组成。一个本地的套接字可能会链接着多个外部的不同套接字。数据在TCP链接中是可以双向传输的，这就是"双全工"。

> 译者注：双全工英文为"full duplex"

TCP理论上可以绑定到任何端口号，这由使用TCP协议的具体实现（上层协议）来选择。不过我们也希望不管是哪种基于TCP的协议实现都能有几个基本的共识。第一个，某些上层协议最好有自己的为人熟知的端口号，我们可以预见到未来很可能是这样的。如何让某个端口变成上层协议的专属端口，这个问题是上层协议自己该考虑的。不过我们认为一个请求端口可能由用户命令指定，或者将某个批次的端口都关联到某个协议，该批次的端口具有统一的特点，比如二进制的若干几位一样。

> 译者注：本段落仅仅是在谈TCP设计者对上层协议是如何选择端口的一种设想，事实证明，现在很多TCP上层协议确实有自己的默认端口，比如FTP为20或21，HTTP为80等。另外原文中使用了process这个单词来代表"使用TCP协议的服务流程"，本文中就理解成了上层协议实现，比如FTP和HTTP等。

要打开一个本地（服务端）的TCP服务，需要指定好本地的端口号和外来套接字的信息。这时候TCP会提供一个简短的本地链接名称给外部套接字（客户端），客户端在后续的通信中需要使用这个短名字来指定通信所使用的链接。另外，有几个关于链接的事情不得不提。首先，为了表达信息，我们设计了一个用于持久化的数据结构，叫做"Transmission Control Block (TCB)"——传输控制块。一种实现方法是搞一个指针，指针本身的值就是本地链接的名字，指针指向的值就是这个链接使用的传输控制块。另外，"链接打开"请求中还包含了建立的链接是积极的还是被动的。

> 译者注：积极的和被动的分别代表了客户端请求链接服务端和服务端打开服务等待链接两种场景。下文会具体阐述。

一个被动的"链接打开"请求意味着这次链接过程的目的是等待输入型的请求，而不是发起一个真正的传输数据的链接。通常来说，被动型链接可以接受来自任何调用者的链接请求。上一段落我们指出，要打开"链接"，必须指定一个外部套接字，但被动型链接创建的时候并没有具体的外部套接字，为了满足这一特性，我们提出将被动型链接打开的外部套接字统一设置为"0.0.0.0:0"（全零套接字），并且这个非特指的套接字仅仅适用于被动型链接。

一个服务流程（上层服务协议）如果想为其他客户端服务，被他们消费，那么就必须发起一个被动型链接，并且绑定一个全零套接字。然后其他客户端就可以发起主动型链接了。顺便说一句，要是这个本地服务套接字是为人熟知的，那就更好了。

> 译者注：为什么就更好了，意在表达作者希望套接字能规范化，不要随意使用端口。对照当下来看，0～1023为公认端口（Well Known Ports），这是作者提倡的。当然了并不是所有上层协议都一定要特定端口。

公认套接字是一种方便的机制，用来访问一些标准的服务，本质是一种约定大于配置的设计思想。想象一下，如果所有网站的端口都不一定为80，那么我们敲网址和端口会是多么费心的一件事。其他的，比如"Telnet-Server"协议永久的绑定了一个套接字(localhost:23)，文件传输、远程任务入口、文本生成、Echoer和Sink等协议都是如此。另外，我们应当预留一个套接字，用来做"查询"服务，它将告诉客户端最新的服务所绑定的套接字。公认套接字属于TCP规范的一部分，而套接字分配则没有写进去。

> 译者注：套接字分配，据我所知现实场景下实现的比较少，有也是各个服务或协议自己搞的应用层实现。

协议服务可以打开一个被动型的端口，等待来自其他客户端的主动型打开请求。另外两个端同时发起主动型"链接打开"请求时也能正确链接。这种灵活性在某些场景下十分关键，比如某个分布式计算系统中，各个节点都需要两两提供异步服务。

> 译者注：同时向彼此发起打开链接的请求，这个场景译者倒是没遇到过。一般的场景下都是先启动一个服务，然后等着客户端来链接。即便在P2P协议里，被链接的对等服务器资深也是有端口事先开放的。



## 3.4 建立链接

1. 如果链接不存在（CLOSED），这时候所有的请求都会返回RESET，除非对方发过来的也是RESET。特别的，如果SYN请求发向了一个不存在的链接，也是通过这种方式被拒绝回来的。
  如果收到的TCP包有一个ACK字段，那么我们从这个ACK中取出序列号作为SYN序列号，否则返回的RESET指令中的SYN序列号设置为0。返回的ACK字段则设置为SYN序列号+收到的包长度。最终整个链接状态还是停留在CLOSED。
2. 如果链接处于非同步状态（LISTEN，SYN-SENT，SYN-RECEIVED），并且收到TCP包中ACK字段为一个未发送的SYN序列号（也就是收到的包包含了一个非法值），或者由于一些安全策略，该请求无法匹配当前的安全要求，立即返回RESET。
 如果我们发出的SYN序列号还没有被确认，并且收到的包的优先级高于发出去的包，这时有两个选择（决定权在上层协议如何实现），要么是上调本地TCB的优先级，要么就返回RESET。如果优先级比本地低或者刚好，那继续通信即可。 反过来想象一下，如果本地发出了一个高优先级的ACK包，而远端TCP无法上调它自身的优先级，那么它就会发送RESET回来，然后这个链接就会被中断。如果我们的SYN请求已经被确认了，并且可能就是当下收到的返回包，那么其优先级一定要和本地TCB一致，如果不匹配，立即返回RESET。 
  如果收到的包含有ACK字段，那么发出去的RESET包中的SYN码为该ACK序列号，否则就为0。返回的ACK字段值则为SYN序列号+收到的包长度。最终整个链接状态还是停留在原状态。
  
> 译者注：原文经常出现xxx TCP，代指的就是TCP的某一端。意会即可。

> 译者注：序列号大小可能不仅仅通过数值大小来判断，准确的说序列号大小更像是优先度。

> 译者注：匹配的意思可能是相同，也可能是加一，或者其他的规则，具体由实现决定。原文中也用的很乱，有时候相等，有时候加一。下图这个就是相等。

> 译者注：停留在原状态是站在本地TCP来看的，远端的TCP是什么样，需要站在它的角度看来决策。

      TCP A                                           TCP B

  1.  (CRASH)                               (send 300,receive 100)

  2.  CLOSED                                           ESTABLISHED

  3.  SYN-SENT --> <SEQ=400><CTL=SYN>              --> (??)

  4.  (!!)     <-- <SEQ=300><ACK=100><CTL=ACK>     <-- ESTABLISHED

  5.  SYN-SENT --> <SEQ=100><CTL=RST>              --> (Abort!!)

  6.  SYN-SENT                                         CLOSED

  7.  SYN-SENT --> <SEQ=400><CTL=SYN>              -->

                     Half-Open Connection Discovery

                               Figure 1.

3. 如果链接状态已经处于同步（握手）后的状态（ESTABLISHED，FIN-WAIT-1，FIN-WAIT-2，CLOSE-WAIT，CLOSING，LAST-ACK，TIME-WAIT），收到任何无法接受的包（在窗口序列号之外，或者压根就是非法的序列号）时，都需要返回一个空的ACK包，这个包包含一个自己的SYN序列号（放在SYN字段）和下一个希望被收到的对方的序列号（放在ACK字段），如下图所示。最终整个链接保持在原有状态。

                  <SEQ=LOCAL_SEQ><ACK=EXPECTED_SEQ><CTL=ACK>            

                  Empty Acknowlegement Package Composition

                               Figure 2.
                               
  如果收到的包的安全级别、层次和优先级与本地TCB不一致，立即返回RESET，并且关闭链接。